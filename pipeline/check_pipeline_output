#!/usr/bin/env bash
# shellcheck disable=SC2155

function main() {
    local runDirs=("$@");
    echo
    for runDir in "${runDirs[@]}"; do
        info "-----------------------"
        info " Checking Rundir path:  ${runDir}"
        info "-----------------------"

        DirsizeCheck "${runDir}"
        PipelineCheckLogCheck "${runDir}"
        iniEnabled CNV_FREEC "${runDir}" &&
            FreecPngCheck "${runDir}"
        iniEnabled SOMATIC_VARIANTS "${runDir}" &&
            SomaticsMergedCheck "${runDir}"
        iniEnabled SOMATIC_VARIANTS "${runDir}" &&
            SomaticsMeltedCheck "${runDir}"
        iniEnabled INDELREALIGNMENT "${runDir}" &&
            BamSliceCheck "${runDir}"
        iniEnabled INDELREALIGNMENT "${runDir}" &&
            PrePostRealignDiffCheck "${runDir}"
        iniEnabled ANNOTATE_VARIANTS "${runDir}" &&
            VcfSliceCheck "${runDir}"
        WGSMetricsCheck "${runDir}"
        iniEnabled KINSHIP "${runDir}" &&
            KinshipCheck "${runDir}"
        ReadMeCheck "${runDir}"
        echo
    done
    ShowCommands "${runDir}"
}

function iniEnabled() {
    local key=$1 && shift
    local runDir=$1 && shift
    local logsDir=${runDir}/logs
    local iniFile=$(find "${logsDir}" -maxdepth 1 -name "*.ini")
    local iniFileCount=$(echo "${iniFile}" | wc -l)
    if [[ ${iniFileCount} -ne 1 ]]; then
        error "No (unique) INI file found!"
    else
        local value=$(grep -E "^${key}\s+" "${iniFile}" | cut -f2)
        [[ ${value} == "yes" ]] || info "${key} disabled" && return 1
    fi
}

function FreecPngCheck() {
    local runDir=$1 && shift
    local copynumberDir=${runDir}/copyNumber
    if [[ -n $(find "${copynumberDir}/*/freec/" -mindepth 1 -maxdepth 1 -iname "*.png" 2>/dev/null) ]]; then
        ok
    else
        fail "No Freec copy number PNG present!"
    fi
}

function DirsizeCheck() {
    local runDir=$1 && shift
    if [[ ! -d "${runDir}" ]]; then
        error "Rundir does not exist (${runDir})"
    else
        local dirSize=$(du -sh "${runDir}" | cut -f 1)
        maybeOk "${dirSize}"
    fi
}

function PipelineCheckLogCheck() {
    local runDir=$1 && shift
    local logsDir=${runDir}/logs
    local checkFile=${logsDir}/PipelineCheck.log
    if [[ ! -s "${checkFile}" ]]; then
        error "${checkFile} does not exist"
    else
        info "Version: $(grep "Pipeline version" "${checkFile}" 2>/dev/null)"
        if tail -1 "${checkFile}" 2>/dev/null | grep -q "pipeline completed successfully"; then
            ok
        else
            fail "Pipeline Error!"
            cat "${checkFile}"
        fi
    fi
}

function SomaticsMergedCheck() {
    local runDir=$1 && shift
    local somaticsDir=${runDir}/somaticVariants
    if [[ -n $(find "${somaticsDir}" -mindepth 2 -maxdepth 2 -wholename "*_merged_somatics.vcf" 2>/dev/null) ]]; then
        ok
    else
        fail "No merged somatics VCF found!"
    fi
}

function SomaticsMeltedCheck() {
    local runDir=$1 && shift
    local meltedFile=$(find "${somaticsDir}" -mindepth 2 -maxdepth 2 -wholename "*_melted.vcf" 2>/dev/null | head -1)
    if [[ -n ${meltedFile} ]]; then
        local meltedCount=$(wc -l "${meltedFile}" | cut -d" " -f 1)
        ok "(${meltedCount} lines in file)"
    else
        fail "No melted somatics VCF found!"
    fi
}

function BamSliceCheck() {
    local runDir=$1 && shift
    if [[ -n $(find "${runDir}" -mindepth 3 -maxdepth 3 -wholename "*/mapping/*realigned.sliced*.bam" 2>/dev/null) ]]; then
        ok
    else
        fail "No BAM slice found!"
    fi
}

function PrePostRealignDiffCheck() {
    local runDir=$1 && shift
    if [[ -n $(find "${runDir}" -mindepth 3 -maxdepth 3 -wholename "*/mapping/*prepostrealign.diff" 2>/dev/null) ]]; then
        ok
    else
        fail "No PrePostRealignDiff found!"
    fi
}

function VcfSliceCheck() {
    local runDir=$1 && shift
    if [[ -n $(find "${runDir}" -maxdepth 1 -iname "*sliced*.vcf") ]]; then
        ok
    else
        fail "No VCF slice found!"
    fi
}

function WGSMetricsCheck() {
    local runDir=$1 && shift
    local qcstatsDir=${runDir}/QCStats
    local wgsmetricsFile="${qcstatsDir}/WGSMetrics_summary.txt"
    if [[ -e ${wgsmetricsFile} ]]; then
        maybeOk "$(cut -f 1,3,4,5,8,13 "${wgsmetricsFile}" | column -t)"
    else
        fail "No WGSMetrics file found!"
    fi
}

function KinshipCheck() {
    local runDir=$1 && shift
    local kinshipFile=$(find "${runDir}" -maxdepth 1 -mindepth 1 -type f -iname "*.kinship")
    if [[ -n ${kinshipFile} ]]; then
        maybeOk "$(cut -f 2,4,6,7,8 "${kinshipFile}" | column -t)"
    else
        fail "No kinship file found!"
    fi
}

function ReadMeCheck() {
    local runDir=$1 && shift
    local readmeFile=${runDir}/README
    if [[ -s ${readmeFile} ]]; then
        maybeOk "$(cat "${readmeFile}")"
    fi
}

function ShowCommands() {
    local runDir=$1 && shift
    if [[ $(hostname) != "hmf_datastore" ]]; then
        echo
        info "Various commands for quick access"
        info "Commands to copy QCStats to NAS webserver location:"
        for runDir in "${runDirs[@]}"; do
            local runName=$(basename "${runDir}")
            local qcstatsDir=${runDir}/QCStats
            echo "rsync -ahP --stats ${qcstatsDir} nas:/volume1/web/testwebsite/qc/pipeline/${runName}_QCStats"
        done
    fi
}

function log() {
    local level=$1 && shift
    local msg=$1 && shift
    echo "[${level}] ${msg}"
}

function error() {
    log "ERROR" "$1"
    exit 1
}

function warn() {
    log "WARN" "$1"
}

function info() {
    log "INFO" "$1"
}

function ok() {
    local note=${1+" $1"}
    info "${FUNCNAME[1]} OK${note}"
}

function maybeOk() {
    local data=$1 && shift
    info "${FUNCNAME[1]}"
    echo "$data"
}

function fail() {
    local cause=$1 && shift
    warn "${FUNCNAME[1]}: ${cause}"
}

if [[ $# -eq 0 ]]; then
    echo "---"
    echo " Descr: Performs some checks on certain output files and prints all to screen"
    echo " Usage: $(basename "$0") /path/to/pipeline/output/dir/"
    echo "        $(basename "$0") /path1 /path2"
    echo "---"
    exit 1
else
    main "$@"
fi
